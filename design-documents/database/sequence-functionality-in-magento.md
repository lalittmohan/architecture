## Sequence functionality in Magento

### Terms

**Entity UUID** - universally unique identifier, user-defined OR auto-generated by system

### Overview

#### Sequence mechanism
In Magento there is a sequence mechanism, which provides system-generated entity identifier. We already have this mechanism for the following entities:

**Magento CE (SalesSequence):**
* Order
* Invoice
* Shipment
* Credit memo

**Magento EE (Staging):**
* Product
* Category
* CMS page
* CMS block
* Catalog rule
* Sales rule
* Product bundle option
* Product bundle section

As you can see in Magento EE we have much more entities that use sequence mechanism. 
This causes bugs when CE specific functionality are not fully compatible with the EE, due to the fact that some entities use sequence mechanism in EE.
This affects the contributions of community members.

#### Staging specific database changes
The following entities in EE even use the new primary key for main entity tables - **_row_id_**:
* Product
* Category
* CMS page
* CMS block
* Catalog rule
* Sales rule

These changes were introduced by the Staging functionality. 
The part of functionality that is responsible for updating of foreign keys is hidden in schema Recurring scripts not even in Staging modules:
* app/code/Magento/AdvancedSalesRule/Setup/Recurring.php
* app/code/Magento/Banner/Setup/Recurring.php
* app/code/Magento/CatalogEvent/Setup/Recurring.php
* app/code/Magento/CatalogPermissions/Setup/Recurring.php
* app/code/Magento/GiftRegistry/Setup/Recurring.php
* app/code/Magento/Reminder/Setup/Recurring.php
* app/code/Magento/TargetRule/Setup/Recurring.php
* app/code/Magento/VersionsCms/Setup/Recurring.php
* app/code/Magento/VisualMerchandiser/Setup/Recurring.php

The solution is implemented declaratively using DI, but it still causes some issues with upgrade in EE. 

#### Declarative Schema issue
Due to specific install/upgrade flow, when we use Declarative Schema, most of Staging foreign keys recreates on each upgrade.

We have 3 ways to explicitly declare new Staging sequence foreign keys:

1. Add 10 new dependencies into 4 Staging modules
2. Introduce about 10 new modules to solve all new dependencies
3. Move database changes from Staging modules into corresponding CE modules

## Solution

The simplest way to do without backward-incompatible changes which can be implemented in a patch release is the option one - add 10 new dependencies into 4 Staging modules.
This may be a temporary solution of the existing issue.

* CatalogRuleStaging/composer.json
```json
{
    "magento/module-banner": "*"
}
```

* CatalogStaging/composer.json
```json
{
    "magento/module-catalog-event": "*",
    "magento/module-catalog-permissions": "*",
    "magento/module-gift-registry": "*",
    "magento/module-target-rule": "*",
    "magento/module-visual-merchandiser": "*"
}
```

* CmsStaging/composer.json
```json
{
    "magento/module-versions-cms": "*"
}
```

* SalesRuleStaging/composer.json
```json
{
    "magento/module-banner": "*",
    "magento/module-reminder": "*",
    "magento/module-advanced-sales-rule": "*"
}
```
Only 9 of them are unique, but now 7 of them are dependencies for Enterprise module, which is de facto mandatory for EE edition. 
This means that these 7 modules cannot be disabled any way and only 2 modules will be locked to disable by Staging.

* Enterprise/composer.json
```json
{
    "require": {
            "magento/module-banner": "*",
            "magento/module-catalog-event": "*",
            "magento/module-catalog-permissions": "*",
            "magento/module-gift-registry": "*",
            "magento/module-reminder": "*",
            "magento/module-target-rule": "*",
            "magento/module-versions-cms": "*"
    }
}
```
## Alternative way

Let's look at pros and cons of moving all the sequence functionality into CE:

**PROS**
* All significant changes for the entity tables will be in CE, in the corresponding modules 
* We collect all the sequence functionality in one place - CE.
  We may even think of moving it into the Framework and replace it with an UUID mechanism
* This will simplify contributions of community members and increase compatibility of their modules

**CONS**
* For some entity tables, we will have unnecessary changes in CE 


